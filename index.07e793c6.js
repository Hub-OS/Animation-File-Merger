function t(t){return t&&t.__esModule?t.default:t}h=function(t){var e=t[0],i="'"===e;return t.substring(1,t.length-1).replace(/\\\\/g,"\\").replace(i?/\\'/g:/\\"/g,e)};const e=/\S/g,i=/[\s=]/g;function r(t,e,i){return e.lastIndex=i,e.exec(t)}function o(t,o){let n;let a={},s=t.indexOf(" ");if(s<0)return a;for(;n=r(t,e,s);){if(!(n=r(t,i,s=n.index)))throw Error(`Unexpected "${t.slice(s)}" on line ${o}`);let l=t.slice(s,n.index),u=t.indexOf("=",n.index);if(u<0)throw Error(`Attribute is missing "=" on line ${o}`);if(!(n=r(t,e,u+1)))throw Error(`Attribute is missing value on line ${o}`);let f=n.index,d="";if('"'==t[f]){let e=function(t,e){for(;;){if((e=t.indexOf('"',e))<0)return -1;if(!function(t,e){let i=!1;for(;e>0&&"\\"==t[e-=1];)i=!i;return i}(t,e))break;e+=1}return e}(t,f+1);if(e<0)throw Error(`String missing closing quote on line ${o}`);e+=1,d=h(t.slice(f,e)),s=e}else{let e=t.indexOf(" ",f);e<0&&(e=t.length),d=t.slice(f,e),s=e}a[l]=d}return a}function n(t,e,i={quoteAllValues:!0}){let r=[t];for(let t in e){let o=e[t];switch(typeof o){case"string":""!=o&&(r.push(" "),r.push(t),r.push("="),r.push('"'+o.replace(/\\|"/g,function(t){return"\\"+t})+'"'));break;case"number":0!=o&&(i.quoteAllValues?r.push(` ${t}="${o}"`):r.push(` ${t}=${o}`));break;case"boolean":!0==o&&(r.push(" "),r.push(t),i.quoteAllValues?r.push('="1"'):r.push("=1"));break;case"object":if(Array.isArray(o))break;default:throw Error(`Unexpected ${typeof o} for ${t}`)}}return r.join("")}function a(t){let e=[];for(let i of t){for(let t of(e.push(n("animation",i)),i.frames))for(let i of(e.push(n("frame",t)),t.points))e.push(n("point",i));e.push("")}return e.join("\n")}var h,s={},l={},u=function(){};u.prototype={fit:function(t){var e,i,r,o,n=t.length,a=n>0?t[0].width:0,h=n>0?t[0].height:0;for(e=0,this.root={x:0,y:0,width:a,height:h};e<n;e++)r=t[e],o=(i=this.findNode(this.root,r.width,r.height))?this.splitNode(i,r.width,r.height):this.growNode(r.width,r.height),r.x=o.x,r.y=o.y},findNode:function(t,e,i){return t.used?this.findNode(t.right,e,i)||this.findNode(t.down,e,i):e<=t.width&&i<=t.height?t:null},splitNode:function(t,e,i){return t.used=!0,t.down={x:t.x,y:t.y+i,width:t.width,height:t.height-i},t.right={x:t.x+e,y:t.y,width:t.width-e,height:i},t},growNode:function(t,e){var i=t<=this.root.width,r=e<=this.root.height,o=r&&this.root.height>=this.root.width+t,n=i&&this.root.width>=this.root.height+e;return o?this.growRight(t,e):n?this.growDown(t,e):r?this.growRight(t,e):i?this.growDown(t,e):null},growRight:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width+t,height:this.root.height,down:this.root,right:{x:this.root.width,y:0,width:t,height:this.root.height}},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null},growDown:function(t,e){var i;return(this.root={used:!0,x:0,y:0,width:this.root.width,height:this.root.height+e,down:{x:0,y:this.root.height,width:this.root.width,height:e},right:this.root},i=this.findNode(this.root,t,e))?this.splitNode(i,t,e):null}},l=u,s=function(t,e){e=e||{};var i=new l,r=e.inPlace||!1,o=t.map(function(t){return r?t:{width:t.width,height:t.height,item:t}});o=o.sort(function(t,e){return e.width*e.height-t.width*t.height}),i.fit(o);var n={width:o.reduce(function(t,e){return Math.max(t,e.x+e.width)},0),height:o.reduce(function(t,e){return Math.max(t,e.y+e.height)},0)};return r||(n.items=o),n};const f=document.getElementById("sheet-list");function d(t){let e=document.getElementById("sheet-list-item-template");for(let i of(f.textContent="",t.sheets)){let r=e.content.cloneNode(!0);if(r.querySelector(".sheet-name").innerText=i.name,!i.image||!i.animations){let t=r.querySelector(".error-text");i.animationError?t.innerText=i.animationError:i.imageError?t.innerText=i.imageError:i.animations?i.image||(t.innerText="Missing image file"):t.innerText="Missing .animation file"}r.querySelector(".remove-file-button").onclick=function(){t.remove(i.name),d(t)},f.appendChild(r)}}const m=new class{findOrInsert(t){let e=this.sheets.find(e=>e.name==t);return e||(e={name:t},this.sheets.push(e)),e}remove(t){let e=this.sheets.findIndex(e=>e.name==t);this.sheets.splice(e,1)}constructor(){this.sheets=[]}};function g(t){console.error(t),alert(t)}async function c(t){for(let i of t){var e;let t=(e=i.name).slice(0,e.lastIndexOf(".")),r=m.findOrInsert(t);if(i.name.endsWith(".png"))try{r.image=await function(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){let o=new Image;o.src=r.result,o.onload=function(){e(o)},o.onerror=function(){i(Error(`Failed to load "${t.name}"`))}},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsDataURL(t)})}(i),r.imageError=void 0}catch(t){console.error(t),r.imageError=t.toString()}else if(i.name.endsWith(".animation"))try{let t=await function(t){return new Promise((e,i)=>{let r=new FileReader;r.onload=function(){e(r.result)},r.onerror=function(){i(Error(`Failed to load "${t.name}: ${r.error}"`))},r.readAsText(t)})}(i);r.animations=function(t){let e,i;let r=[],n=0;for(let a of t.split("\n"))if(a=a.trim(),n+=1,!(""==a||a.startsWith("#")||a.startsWith("imagePath")||a.startsWith("version"))){if(a.startsWith("animation ")){let t=o(a,n),i={state:t.state,frames:[]};if(!t.state)throw Error(`Animation is missing state name on line ${n}`);r.push(i),e=i}else if(a.startsWith("frame")||a.startsWith("blank")){if(!e)throw Error(`No animation state to associate frame with on line ${n}`);let t=o(a,n),r={x:parseFloat(t.x)||0,y:parseFloat(t.y)||0,w:parseFloat(t.w)||0,h:parseFloat(t.h)||0,originx:parseFloat(t.originx)||0,originy:parseFloat(t.originy)||0,flipx:1==parseInt(t.flipx),flipy:1==parseInt(t.flipy),duration:t.duration||"",points:[]};e.frames.push(r),i=r}else if(a.startsWith("point ")){if(!i)throw Error(`No frame to associate point with on line ${n}`);let t=o(a,n);if(!t.label)throw Error(`Point is missing label on line ${n}`);let e={label:t.label,x:parseFloat(t.x),y:parseFloat(t.y)};i.points.push(e)}else{let t=a.indexOf(" "),e=t<0?a:a.slice(0,t);throw Error(`Unexpected "${e}" on line ${n}`)}}return r}(t),r.animationError=void 0}catch(t){console.error(t),r.animationError=t.toString()}}}document.getElementById("clear-button").onclick=function(){m.sheets=[],d(m)},document.getElementById("overlay-button").onclick=function(){let e=document.querySelector("#output canvas"),i=document.querySelector("#output textarea");try{let r=function(e,i){let r={};for(let t=0;t<i.sheets.length;t++){let e=i.sheets[t];if(e.animations&&e.image)for(let i of e.animations){let e=r[i.state];e||(e=[],r[i.state]=e);let n=0;for(let r of i.frames){var o;let i=(o=(o=r.duration).trim()).toLowerCase().endsWith("f")?parseFloat(o.slice(0,-1))/60:parseFloat(o);for(;i>0;){let o=e[n];if(n+=1,!o){let o=e[e.length-1]?.overlayed||[];e.push({overlayed:[...o.filter(({sheetIndex:e})=>e!=t),{sheetIndex:t,frame:r}],outFrame:{x:0,y:0,w:r.w,h:r.h,originx:r.originx,originy:r.originy,flipx:!1,flipy:!1,duration:"",points:[]},duration:i,width:0,height:0});break}o.duration>i&&(e.splice(n+1,0,structuredClone(o)),o.duration=i),i-=o.duration,o.overlayed.push({sheetIndex:t,frame:r}),o.outFrame.originx=Math.max(o.outFrame.originx,r.originx),o.outFrame.originy=Math.max(o.outFrame.originy,r.originy)}}}}let n=Object.values(r).flat();for(let t of n){for(let{frame:e}of(t.outFrame,t.overlayed))t.width=Math.max(t.width,t.outFrame.originx-e.originx+e.w),t.height=Math.max(t.height,t.outFrame.originy-e.originy+e.h);t.outFrame.w=t.width,t.outFrame.h=t.height}let a=t(s)(n);e.width=a.width,e.height=a.height;let h=e.getContext("2d");for(let t of a.items){let e=t.x+1,r=t.y+1,{outFrame:o}=t.item;for(let{sheetIndex:n,frame:a}of(o.x=e,o.y=r,o.duration=t.item.duration.toString(),t.item.overlayed)){let t=i.sheets[n].image;t&&h.drawImage(t,a.x,a.y,a.w,a.h,o.x+o.originx-a.originx,o.y+o.originy-a.originy,a.w,a.h)}}return Object.entries(r).map(([t,e])=>({state:t,frames:e.map(t=>t.outFrame)}))}(e,m);i.value=a(r)}catch(t){g(t)}},document.getElementById("merge-button").onclick=function(){let e=document.querySelector("#output canvas"),i=document.querySelector("#output textarea");try{let r=function(e,i){let r=[],o=[];for(let t of i.sheets){if(!t.animations||!t.image)continue;let e=structuredClone(t.animations);for(let i of(r.push(...e),e))for(let e of i.frames)o.push({image:t.image,frame:e,width:e.w+2,height:e.h+2})}let n=t(s)(o);e.width=n.width,e.height=n.height;let a=e.getContext("2d");for(let t of n.items){let e=t.item.frame,i=t.x+1,r=t.y+1;a.drawImage(t.item.image,e.x,e.y,e.w,e.h,i,r,e.w,e.h),e.x=i,e.y=r}return r}(e,m);i.value=a(r)}catch(t){g(t)}},document.body.addEventListener("dragover",t=>t.preventDefault()),document.body.addEventListener("drop",t=>{let e=t.dataTransfer?.items;if(!e)return;t.preventDefault();let i=[];for(let t of e){let e=t.getAsFile();e&&i.push(e)}c(i).catch(g).finally(()=>{d(m)})});
//# sourceMappingURL=index.07e793c6.js.map
